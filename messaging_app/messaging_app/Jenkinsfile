/**
 * Jenkins Pipeline for the Django Messaging App:
 * - Checkout from GitHub (with credentials)
 * - Install dependencies
 * - Run pytest + publish JUnit report
 * - Build Docker image
 * - Push Docker image to Docker Hub
 *
 * Trigger manually from Jenkins UI (no automatic triggers configured).
 */

pipeline {
    agent any

    options {
        timestamps()
        ansiColor('xterm')
    }

    environment {
        // -----------------------------
        // GitHub settings
        // -----------------------------
        GIT_REPO_URL = 'https://github.com/<YOUR_GITHUB_USERNAME>/alx-backend-python.git'
        GIT_BRANCH   = 'main'
        GIT_CRED_ID  = 'github-credentials'

        // App directory inside repo
        APP_DIR      = 'messaging_app'

        // -----------------------------
        // Test report output
        // -----------------------------
        REPORT_DIR   = 'test-reports'
        JUNIT_XML    = 'pytest-report.xml'

        // -----------------------------
        // Docker / Docker Hub settings
        // -----------------------------
        DOCKERHUB_CRED_ID = 'dockerhub-credentials'   // Jenkins Credentials ID
        DOCKERHUB_USER    = '<YOUR_DOCKERHUB_USERNAME>'
        IMAGE_NAME        = 'messaging-app'

        // Use build number for versioned tags; also push latest
        IMAGE_TAG         = "${BUILD_NUMBER}"
        FULL_IMAGE_TAG    = "${DOCKERHUB_USER}/${IMAGE_NAME}:${IMAGE_TAG}"
        FULL_IMAGE_LATEST = "${DOCKERHUB_USER}/${IMAGE_NAME}:latest"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${env.GIT_BRANCH}"]],
                    userRemoteConfigs: [[
                        url: env.GIT_REPO_URL,
                        credentialsId: env.GIT_CRED_ID
                    ]]
                ])
            }
        }

        stage('Install Dependencies') {
            steps {
                dir(env.APP_DIR) {
                    sh '''
                        set -eux
                        python3 --version
                        pip3 --version

                        python3 -m venv .venv
                        . .venv/bin/activate

                        pip install --upgrade pip
                        if [ -f requirements.txt ]; then
                          pip install -r requirements.txt
                        fi

                        pip install pytest pytest-cov
                    '''
                }
            }
        }

        stage('Run Tests (pytest)') {
            steps {
                dir(env.APP_DIR) {
                    sh '''
                        set -eux
                        . .venv/bin/activate

                        mkdir -p "${REPORT_DIR}"
                        pytest -q --junitxml="${REPORT_DIR}/${JUNIT_XML}"
                    '''
                }
            }
        }

        stage('Publish Report') {
            steps {
                dir(env.APP_DIR) {
                    junit allowEmptyResults: false, testResults: "${REPORT_DIR}/${JUNIT_XML}"
                    archiveArtifacts artifacts: "${REPORT_DIR}/*", fingerprint: true
                }
            }
        }

        stage('Docker Build') {
            steps {
                dir(env.APP_DIR) {
                    sh '''
                        set -eux
                        docker --version

                        # Build from the Dockerfile inside messaging_app/
                        docker build -t "${FULL_IMAGE_TAG}" .
                        docker tag "${FULL_IMAGE_TAG}" "${FULL_IMAGE_LATEST}"

                        docker images | head -n 20
                    '''
                }
            }
        }

        stage('Docker Push') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: env.DOCKERHUB_CRED_ID,
                    usernameVariable: 'DH_USER',
                    passwordVariable: 'DH_PASS'
                )]) {
                    sh '''
                        set -eux

                        echo "$DH_PASS" | docker login -u "$DH_USER" --password-stdin

                        docker push "${FULL_IMAGE_TAG}"
                        docker push "${FULL_IMAGE_LATEST}"

                        docker logout
                    '''
                }
            }
        }
    }

    post {
        success {
            echo "✅ Build + tests passed and Docker image pushed:"
            echo " - ${env.FULL_IMAGE_TAG}"
            echo " - ${env.FULL_IMAGE_LATEST}"
        }
        failure {
            echo "❌ Pipeline failed. Check logs and test reports."
        }
        always {
            echo "Pipeline finished."
        }
    }
}
