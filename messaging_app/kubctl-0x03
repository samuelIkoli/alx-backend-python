#!/usr/bin/env bash
# kubctl-0x03: Perform a rolling update on Django messaging app and check for downtime.

set -euo pipefail

DEPLOYMENT="messaging-app-blue"
SERVICE="messaging-app-service"

echo "ğŸš€ Applying updated deployment (image v2.0)..."
kubectl apply -f messaging_app/blue_deployment.yaml

echo ""
echo "ğŸ”„ Starting rolling update..."
kubectl rollout status deployment/$DEPLOYMENT &

ROLL_PID=$!

echo ""
echo "ğŸŒ Starting continuous curl to detect downtime (press CTRL+C to stop)..."

# Start background curl loop
DOWNTIME=0
(
  while true; do
    if ! curl -s http://localhost:8000/ > /dev/null; then
      echo "âŒ Downtime detected!"
      DOWNTIME=1
    else
      echo "âœ” App responding normally..."
    fi
    sleep 0.3
  done
) &

CURL_PID=$!

wait $ROLL_PID

echo ""
echo "ğŸ›‘ Stopping curl checks..."
kill $CURL_PID || true

if [[ "$DOWNTIME" -eq 0 ]]; then
  echo "ğŸ‰ Rolling update completed with ZERO downtime!"
else
  echo "âš  Rolling update completed, but downtime was detected."
fi

echo ""
echo "ğŸ“¦ Current pods after rollout:"
kubectl get pods -o wide

echo ""
echo "âœ… Script completed."
