/**
 * Jenkins Pipeline for the Django Messaging App:
 * - Checkout code from GitHub using stored credentials
 * - Install dependencies
 * - Run pytest
 * - Generate & publish test reports
 *
 * This pipeline is intended to be triggered manually from the Jenkins UI.
 */

pipeline {
    agent any

    options {
        timestamps()
        ansiColor('xterm')
    }

    environment {
        // CHANGE THESE TO MATCH YOUR SETUP
        GIT_REPO_URL = 'https://github.com/<YOUR_GITHUB_USERNAME>/alx-backend-python.git'
        GIT_BRANCH   = 'main'

        // Jenkins Credentials ID you create in Jenkins (Username/Password OR Personal Access Token)
        GIT_CRED_ID  = 'github-credentials'

        // Your app lives inside this folder in the repo
        APP_DIR      = 'messaging_app'

        // Reports output
        REPORT_DIR   = 'test-reports'
        JUNIT_XML    = 'pytest-report.xml'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${env.GIT_BRANCH}"]],
                    userRemoteConfigs: [[
                        url: env.GIT_REPO_URL,
                        credentialsId: env.GIT_CRED_ID
                    ]]
                ])
            }
        }

        stage('Install Dependencies') {
            steps {
                dir(env.APP_DIR) {
                    sh '''
                        set -eux

                        python3 --version
                        pip3 --version

                        # Create venv
                        python3 -m venv .venv
                        . .venv/bin/activate

                        pip install --upgrade pip

                        # Install from requirements.txt if present
                        if [ -f requirements.txt ]; then
                          pip install -r requirements.txt
                        fi

                        # Ensure pytest + junitxml support exist even if not in requirements
                        pip install pytest pytest-cov
                    '''
                }
            }
        }

        stage('Run Tests (pytest)') {
            steps {
                dir(env.APP_DIR) {
                    sh '''
                        set -eux
                        . .venv/bin/activate

                        mkdir -p "${REPORT_DIR}"

                        # Run tests + produce JUnit XML output for Jenkins
                        pytest -q --junitxml="${REPORT_DIR}/${JUNIT_XML}"
                    '''
                }
            }
        }

        stage('Publish Report') {
            steps {
                dir(env.APP_DIR) {
                    // Publishes test results in Jenkins "Test Result" view
                    junit allowEmptyResults: false, testResults: "${REPORT_DIR}/${JUNIT_XML}"

                    // Keeps reports as downloadable artifacts
                    archiveArtifacts artifacts: "${REPORT_DIR}/*", fingerprint: true
                }
            }
        }
    }

    post {
        always {
            echo "Pipeline finished. Check 'Test Result' and 'Artifacts' in Jenkins."
        }
        failure {
            echo "Pipeline failed. Check console logs and archived test reports."
        }
    }
}
